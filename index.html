<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi GPS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">üìç Absensi GPS</h1>
            <p class="text-white/80">Sistem absensi dengan lokasi dan token keamanan</p>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="max-w-md mx-auto">
            <!-- Student Login Form -->
            <div id="studentForm" class="bg-white rounded-2xl p-6 card-shadow mb-6">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl">üë®‚Äçüéì</span>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">Absensi Siswa</h2>
                </div>

                <form id="attendanceForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">NISN</label>
                        <input type="text" id="studentNISN" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg" placeholder="Masukkan NISN" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Token Absensi</label>
                        <input type="text" id="attendanceToken" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg text-center font-bold" placeholder="Masukkan token dari guru" required>
                        <div class="mt-2 text-sm text-gray-600">
                            <span class="font-medium">Token berlaku:</span> 
                            <span id="tokenTimer" class="text-blue-600 font-bold">30</span> detik
                        </div>
                    </div>

                    <!-- Location Status -->
                    <div id="locationStatus" class="bg-gray-50 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700">Status Lokasi:</span>
                            <span id="locationText" class="text-sm text-orange-600">Menunggu...</span>
                        </div>
                        <div id="coordinates" class="text-xs text-gray-500 mt-1"></div>
                    </div>

                    <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                        üìç Submit Absensi
                    </button>
                </form>
            </div>

            <!-- Admin Access -->
            <div class="text-center">
                <button id="adminBtn" class="text-white/80 hover:text-white text-sm underline">
                    üîê Akses Admin
                </button>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="max-w-2xl mx-auto hidden">
            <div class="bg-white rounded-2xl p-6 card-shadow">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">üîß Panel Admin</h2>
                    <button id="backToStudent" class="text-blue-600 hover:text-blue-800">
                        ‚Üê Kembali
                    </button>
                </div>

                <!-- Admin Login -->
                <div id="adminLogin" class="mb-6">
                    <div class="flex gap-2">
                        <input type="password" id="adminPassword" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="Password admin">
                        <button id="loginAdmin" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                            Login
                        </button>
                    </div>
                </div>

                <!-- Admin Controls -->
                <div id="adminControls" class="hidden space-y-6">
                    <!-- Admin Navigation -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button id="tokenTab" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">Token</button>
                        <button id="studentsTab" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300">Daftar Siswa</button>
                        <button id="attendanceTab" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300">Rekap Absensi</button>
                    </div>

                    <!-- Token Panel -->
                    <div id="tokenPanel" class="space-y-6">
                        <!-- Current Token Display -->
                        <div class="bg-blue-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-800 mb-2">Token Aktif</h3>
                            <div class="text-center">
                                <div id="currentToken" class="text-3xl font-bold text-blue-600 mb-2 pulse-animation">ABCD1234</div>
                                <div class="text-sm text-gray-600">
                                    Berubah setiap <span id="adminTokenTimer" class="font-bold">30</span> detik
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Students Panel -->
                    <div id="studentsPanel" class="space-y-6 hidden">
                        <!-- Import/Export Controls -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-800 mb-4">Import/Export Data Siswa</h3>
                            <div class="flex flex-wrap gap-2 mb-4">
                                <input type="file" id="importFile" accept=".csv,.xlsx,.xls" class="hidden">
                                <button id="importBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700">
                                    üì• Import Excel/CSV
                                </button>
                                <button id="exportStudentsBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">
                                    üì§ Export Siswa
                                </button>
                                <button id="downloadTemplate" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-700">
                                    üìã Template Import
                                </button>
                            </div>
                        </div>

                        <!-- Add Student Form -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-800 mb-4">Tambah Siswa Manual</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <input type="text" id="newStudentName" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Nama siswa">
                                <input type="text" id="newStudentNISN" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="NISN">
                                <select id="newStudentClass" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="">Pilih Kelas</option>
                                    <option value="X-A">X-A</option>
                                    <option value="X-B">X-B</option>
                                    <option value="XI-A">XI-A</option>
                                    <option value="XI-B">XI-B</option>
                                    <option value="XII-A">XII-A</option>
                                    <option value="XII-B">XII-B</option>
                                </select>
                            </div>
                            <button id="addStudent" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700">
                                + Tambah Siswa
                            </button>
                        </div>

                        <!-- Filter Students -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-800 mb-4">Daftar Siswa</h3>
                            <div class="flex gap-2 mb-4">
                                <select id="classFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="">Semua Kelas</option>
                                    <option value="X-A">X-A</option>
                                    <option value="X-B">X-B</option>
                                    <option value="XI-A">XI-A</option>
                                    <option value="XI-B">XI-B</option>
                                    <option value="XII-A">XII-A</option>
                                    <option value="XII-B">XII-B</option>
                                </select>
                                <input type="text" id="searchStudent" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Cari nama atau NISN...">
                            </div>
                            <div id="studentsList" class="space-y-2 max-h-60 overflow-y-auto">
                                <!-- Students list will be populated here -->
                            </div>
                            <div class="mt-4 text-sm text-gray-600">
                                Total: <span id="studentsCount">0</span> siswa
                            </div>
                        </div>
                    </div>

                    <!-- Attendance Panel -->
                    <div id="attendancePanel" class="space-y-6 hidden">
                        <!-- Export Controls -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-800 mb-4">Export Rekap Absensi</h3>
                            <div class="flex flex-wrap gap-2 mb-4">
                                <button id="exportTodayBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700">
                                    üìä Export Hari Ini
                                </button>
                                <button id="exportAllBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">
                                    üìà Export Semua Data
                                </button>
                            </div>
                        </div>

                        <!-- Attendance Filter -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-800 mb-4">Filter Rekap Absensi</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <select id="attendanceClassFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="">Semua Kelas</option>
                                    <option value="X-A">X-A</option>
                                    <option value="X-B">X-B</option>
                                    <option value="XI-A">XI-A</option>
                                    <option value="XI-B">XI-B</option>
                                    <option value="XII-A">XII-A</option>
                                    <option value="XII-B">XII-B</option>
                                </select>
                                <input type="date" id="attendanceDateFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <input type="text" id="searchAttendance" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Cari nama...">
                            </div>
                        </div>

                        <!-- Attendance Records -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-800 mb-4">Daftar Absensi</h3>
                            <div id="attendanceList" class="space-y-2 max-h-60 overflow-y-auto">
                                <!-- Attendance records will be populated here -->
                            </div>
                            <div class="mt-4 flex justify-between items-center">
                                <div class="text-sm text-gray-600">
                                    Total: <span id="attendanceCount">0</span> absensi
                                </div>
                                <button id="clearAttendance" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-700">
                                    üóëÔ∏è Hapus Semua Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success Modal -->
        <div id="successModal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-2xl p-6 max-w-md w-full text-center">
                <div class="text-6xl mb-4">‚úÖ</div>
                <h3 class="text-xl font-bold text-gray-800 mb-4">Absensi Berhasil!</h3>
                
                <!-- Student Identity Display -->
                <div id="studentIdentity" class="bg-blue-50 rounded-lg p-4 mb-4 text-left">
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="font-medium text-gray-700">Nama:</div>
                        <div id="modalName" class="text-gray-800"></div>
                        <div class="font-medium text-gray-700">NISN:</div>
                        <div id="modalNISN" class="text-gray-800"></div>
                        <div class="font-medium text-gray-700">Kelas:</div>
                        <div id="modalClass" class="text-gray-800"></div>
                        <div class="font-medium text-gray-700">Waktu:</div>
                        <div id="modalTime" class="text-gray-800"></div>
                        <div class="font-medium text-gray-700">Lokasi:</div>
                        <div id="modalLocation" class="text-gray-800 text-xs"></div>
                    </div>
                </div>
                
                <p class="text-gray-600 mb-4">Data absensi telah tersimpan dengan aman</p>
                <button id="closeModal" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                    Tutup
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentToken = 'ABCD1234';
        let tokenTimer = 30;
        let userLocation = null;
        let attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
        let studentDatabase = JSON.parse(localStorage.getItem('studentDatabase') || JSON.stringify([
            { name: 'Ahmad Rizki', nisn: '1234567890', class: 'XII-A' },
            { name: 'Siti Nurhaliza', nisn: '1234567891', class: 'XII-A' },
            { name: 'Budi Santoso', nisn: '1234567892', class: 'XI-B' },
            { name: 'Dewi Sartika', nisn: '1234567893', class: 'X-A' }
        ]));

        // DOM elements
        const studentForm = document.getElementById('studentForm');
        const adminPanel = document.getElementById('adminPanel');
        const adminBtn = document.getElementById('adminBtn');
        const backToStudent = document.getElementById('backToStudent');
        const attendanceForm = document.getElementById('attendanceForm');
        const submitBtn = document.getElementById('submitBtn');
        const locationStatus = document.getElementById('locationStatus');
        const locationText = document.getElementById('locationText');
        const coordinates = document.getElementById('coordinates');
        const tokenTimerEl = document.getElementById('tokenTimer');
        const adminTokenTimerEl = document.getElementById('adminTokenTimer');
        const currentTokenEl = document.getElementById('currentToken');
        const successModal = document.getElementById('successModal');
        const closeModal = document.getElementById('closeModal');
        const adminLogin = document.getElementById('adminLogin');
        const adminControls = document.getElementById('adminControls');
        const loginAdmin = document.getElementById('loginAdmin');
        const adminPassword = document.getElementById('adminPassword');
        const attendanceList = document.getElementById('attendanceList');

        // Initialize app
        function init() {
            requestLocation();
            startTokenTimer();
            updateAttendanceDisplay();
            
            // Disable submit initially
            submitBtn.disabled = true;
        }

        // Location functions
        function requestLocation() {
            if (!navigator.geolocation) {
                locationText.textContent = 'GPS tidak didukung';
                locationText.className = 'text-sm text-red-600';
                return;
            }

            locationText.textContent = 'Mengakses lokasi...';
            locationText.className = 'text-sm text-orange-600';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    locationText.textContent = 'Lokasi terdeteksi ‚úì';
                    locationText.className = 'text-sm text-green-600';
                    coordinates.textContent = `Lat: ${userLocation.latitude.toFixed(6)}, Lng: ${userLocation.longitude.toFixed(6)}`;
                    
                    submitBtn.disabled = false;
                },
                (error) => {
                    let errorMsg = 'Gagal mengakses lokasi';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Akses lokasi ditolak';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Lokasi tidak tersedia';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'Timeout mengakses lokasi';
                            break;
                    }
                    
                    locationText.textContent = errorMsg;
                    locationText.className = 'text-sm text-red-600';
                    coordinates.textContent = 'Harap aktifkan GPS dan izinkan akses lokasi';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        // Token management
        function generateToken() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function startTokenTimer() {
            setInterval(() => {
                tokenTimer--;
                tokenTimerEl.textContent = tokenTimer;
                if (adminTokenTimerEl) {
                    adminTokenTimerEl.textContent = tokenTimer;
                }
                
                if (tokenTimer <= 0) {
                    currentToken = generateToken();
                    currentTokenEl.textContent = currentToken;
                    tokenTimer = 30;
                }
            }, 1000);
        }

        // Form submission
        attendanceForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const nisn = document.getElementById('studentNISN').value;
            const token = document.getElementById('attendanceToken').value;
            
            // Validate token
            if (token !== currentToken) {
                alert('Token tidak valid! Pastikan token yang dimasukkan benar.');
                return;
            }
            
            // Validate location
            if (!userLocation) {
                alert('Lokasi belum terdeteksi! Pastikan GPS aktif dan izinkan akses lokasi.');
                requestLocation();
                return;
            }
            
            // Find student in database
            const student = studentDatabase.find(s => s.nisn === nisn);
            if (!student) {
                alert('NISN tidak ditemukan! Pastikan NISN sudah terdaftar di sistem.');
                return;
            }
            
            // Check if already attended today
            const today = new Date().toDateString();
            const existingRecord = attendanceRecords.find(record => 
                record.nisn === nisn && record.date === today
            );
            
            if (existingRecord) {
                alert('NISN ini sudah melakukan absensi hari ini!');
                return;
            }
            
            const currentTime = new Date().toLocaleTimeString('id-ID');
            
            // Save attendance record
            const attendanceRecord = {
                name: student.name,
                nisn: student.nisn,
                class: student.class,
                date: today,
                time: currentTime,
                location: userLocation,
                timestamp: Date.now()
            };
            
            attendanceRecords.push(attendanceRecord);
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            
            // Update modal with student info
            document.getElementById('modalName').textContent = student.name;
            document.getElementById('modalNISN').textContent = student.nisn;
            document.getElementById('modalClass').textContent = student.class;
            document.getElementById('modalTime').textContent = currentTime;
            document.getElementById('modalLocation').textContent = `${userLocation.latitude.toFixed(6)}, ${userLocation.longitude.toFixed(6)}`;
            
            // Show success modal
            successModal.classList.remove('hidden');
            
            // Reset form
            attendanceForm.reset();
            submitBtn.disabled = true;
            userLocation = null;
            locationText.textContent = 'Menunggu...';
            locationText.className = 'text-sm text-orange-600';
            coordinates.textContent = '';
        });

        // Admin functions
        adminBtn.addEventListener('click', () => {
            studentForm.parentElement.classList.add('hidden');
            adminPanel.classList.remove('hidden');
        });

        backToStudent.addEventListener('click', () => {
            adminPanel.classList.add('hidden');
            studentForm.parentElement.classList.remove('hidden');
            adminControls.classList.add('hidden');
            adminLogin.classList.remove('hidden');
            adminPassword.value = '';
        });

        loginAdmin.addEventListener('click', () => {
            const password = adminPassword.value;
            if (password === 'admin123') {
                adminLogin.classList.add('hidden');
                adminControls.classList.remove('hidden');
                showTokenPanel();
                updateStudentsList();
                updateAttendanceDisplay();
            } else {
                alert('Password admin salah!');
            }
        });

        // Admin panel navigation
        function showTokenPanel() {
            document.getElementById('tokenTab').className = 'px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700';
            document.getElementById('studentsTab').className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300';
            document.getElementById('attendanceTab').className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300';
            
            document.getElementById('tokenPanel').classList.remove('hidden');
            document.getElementById('studentsPanel').classList.add('hidden');
            document.getElementById('attendancePanel').classList.add('hidden');
        }

        function showStudentsPanel() {
            document.getElementById('tokenTab').className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300';
            document.getElementById('studentsTab').className = 'px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700';
            document.getElementById('attendanceTab').className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300';
            
            document.getElementById('tokenPanel').classList.add('hidden');
            document.getElementById('studentsPanel').classList.remove('hidden');
            document.getElementById('attendancePanel').classList.add('hidden');
            updateStudentsList();
        }

        function showAttendancePanel() {
            document.getElementById('tokenTab').className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300';
            document.getElementById('studentsTab').className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300';
            document.getElementById('attendanceTab').className = 'px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700';
            
            document.getElementById('tokenPanel').classList.add('hidden');
            document.getElementById('studentsPanel').classList.add('hidden');
            document.getElementById('attendancePanel').classList.remove('hidden');
            updateAttendanceDisplay();
        }

        document.getElementById('tokenTab').addEventListener('click', showTokenPanel);
        document.getElementById('studentsTab').addEventListener('click', showStudentsPanel);
        document.getElementById('attendanceTab').addEventListener('click', showAttendancePanel);

        // Students management functions
        function updateStudentsList() {
            const classFilter = document.getElementById('classFilter').value;
            const searchTerm = document.getElementById('searchStudent').value.toLowerCase();
            
            let filteredStudents = studentDatabase;
            
            if (classFilter) {
                filteredStudents = filteredStudents.filter(student => student.class === classFilter);
            }
            
            if (searchTerm) {
                filteredStudents = filteredStudents.filter(student => 
                    student.name.toLowerCase().includes(searchTerm) || 
                    student.nisn.includes(searchTerm)
                );
            }
            
            const studentsList = document.getElementById('studentsList');
            studentsList.innerHTML = '';
            
            if (filteredStudents.length === 0) {
                studentsList.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Tidak ada siswa ditemukan</p>';
            } else {
                filteredStudents.forEach((student, index) => {
                    const studentEl = document.createElement('div');
                    studentEl.className = 'bg-white rounded-lg p-3 border border-gray-200 flex justify-between items-center';
                    studentEl.innerHTML = `
                        <div>
                            <div class="font-medium text-gray-800">${student.name}</div>
                            <div class="text-sm text-gray-600">NISN: ${student.nisn} | Kelas: ${student.class}</div>
                        </div>
                        <button onclick="deleteStudent('${student.nisn}')" class="text-red-600 hover:text-red-800 text-sm">
                            üóëÔ∏è Hapus
                        </button>
                    `;
                    studentsList.appendChild(studentEl);
                });
            }
            
            document.getElementById('studentsCount').textContent = filteredStudents.length;
        }

        function deleteStudent(nisn) {
            if (confirm('Yakin ingin menghapus siswa ini?')) {
                studentDatabase = studentDatabase.filter(student => student.nisn !== nisn);
                localStorage.setItem('studentDatabase', JSON.stringify(studentDatabase));
                updateStudentsList();
                alert('Siswa berhasil dihapus!');
            }
        }

        // Add student
        document.getElementById('addStudent').addEventListener('click', () => {
            const name = document.getElementById('newStudentName').value;
            const nisn = document.getElementById('newStudentNISN').value;
            const studentClass = document.getElementById('newStudentClass').value;
            
            if (name && nisn && studentClass) {
                // Check if NISN already exists
                if (studentDatabase.find(student => student.nisn === nisn)) {
                    alert('NISN sudah terdaftar!');
                    return;
                }
                
                const student = { name, nisn, class: studentClass };
                studentDatabase.push(student);
                localStorage.setItem('studentDatabase', JSON.stringify(studentDatabase));
                
                // Clear form
                document.getElementById('newStudentName').value = '';
                document.getElementById('newStudentNISN').value = '';
                document.getElementById('newStudentClass').value = '';
                
                updateStudentsList();
                alert('Siswa berhasil ditambahkan!');
            } else {
                alert('Harap lengkapi semua data siswa!');
            }
        });

        // Filter students
        document.getElementById('classFilter').addEventListener('change', updateStudentsList);
        document.getElementById('searchStudent').addEventListener('input', updateStudentsList);

        // Import/Export event listeners
        document.getElementById('importBtn').addEventListener('click', () => {
            document.getElementById('importFile').click();
        });

        document.getElementById('importFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                importStudents(file);
                e.target.value = ''; // Reset file input
            }
        });

        document.getElementById('exportStudentsBtn').addEventListener('click', exportStudents);
        document.getElementById('downloadTemplate').addEventListener('click', downloadTemplate);
        document.getElementById('exportTodayBtn').addEventListener('click', exportAttendanceToday);
        document.getElementById('exportAllBtn').addEventListener('click', exportAllAttendance);

        // Attendance filters
        document.getElementById('attendanceClassFilter')?.addEventListener('change', updateAttendanceDisplay);
        document.getElementById('attendanceDateFilter')?.addEventListener('change', updateAttendanceDisplay);
        document.getElementById('searchAttendance')?.addEventListener('input', updateAttendanceDisplay);

        // Clear attendance
        document.getElementById('clearAttendance').addEventListener('click', () => {
            if (confirm('Yakin ingin menghapus semua data absensi?')) {
                attendanceRecords = [];
                localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
                updateAttendanceDisplay();
                alert('Data absensi berhasil dihapus!');
            }
        });

        // Import/Export functions
        function downloadTemplate() {
            const csvContent = "data:text/csv;charset=utf-8,Nama,NISN,Kelas\nContoh Siswa,1234567890,XII-A\nSiswa Kedua,1234567891,XI-B";
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "template_siswa.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportStudents() {
            if (studentDatabase.length === 0) {
                alert('Tidak ada data siswa untuk diekspor!');
                return;
            }
            
            const csvContent = "data:text/csv;charset=utf-8,Nama,NISN,Kelas\n" + 
                studentDatabase.map(student => `${student.name},${student.nisn},${student.class}`).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `data_siswa_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportAttendanceToday() {
            const today = new Date().toDateString();
            const todayRecords = attendanceRecords.filter(record => record.date === today);
            
            if (todayRecords.length === 0) {
                alert('Tidak ada data absensi hari ini untuk diekspor!');
                return;
            }
            
            const csvContent = "data:text/csv;charset=utf-8,Nama,NISN,Kelas,Tanggal,Waktu,Latitude,Longitude\n" + 
                todayRecords.map(record => 
                    `${record.name},${record.nisn},${record.class},${record.date},${record.time},${record.location.latitude},${record.location.longitude}`
                ).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `absensi_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportAllAttendance() {
            if (attendanceRecords.length === 0) {
                alert('Tidak ada data absensi untuk diekspor!');
                return;
            }
            
            const csvContent = "data:text/csv;charset=utf-8,Nama,NISN,Kelas,Tanggal,Waktu,Latitude,Longitude\n" + 
                attendanceRecords.map(record => 
                    `${record.name},${record.nisn},${record.class},${record.date},${record.time},${record.location.latitude},${record.location.longitude}`
                ).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `semua_absensi_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function importStudents(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                const headers = lines[0].split(',');
                
                let importedCount = 0;
                let duplicateCount = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        const values = line.split(',');
                        if (values.length >= 3) {
                            const name = values[0].trim();
                            const nisn = values[1].trim();
                            const studentClass = values[2].trim();
                            
                            if (name && nisn && studentClass) {
                                // Check if NISN already exists
                                if (!studentDatabase.find(student => student.nisn === nisn)) {
                                    studentDatabase.push({ name, nisn, class: studentClass });
                                    importedCount++;
                                } else {
                                    duplicateCount++;
                                }
                            }
                        }
                    }
                }
                
                localStorage.setItem('studentDatabase', JSON.stringify(studentDatabase));
                updateStudentsList();
                
                let message = `Import selesai!\n${importedCount} siswa berhasil ditambahkan.`;
                if (duplicateCount > 0) {
                    message += `\n${duplicateCount} siswa diabaikan (NISN sudah ada).`;
                }
                alert(message);
            };
            reader.readAsText(file);
        }

        // Update attendance display
        function updateAttendanceDisplay() {
            const classFilter = document.getElementById('attendanceClassFilter')?.value || '';
            const dateFilter = document.getElementById('attendanceDateFilter')?.value || '';
            const searchTerm = document.getElementById('searchAttendance')?.value.toLowerCase() || '';
            
            let filteredRecords = attendanceRecords;
            
            // Filter by class
            if (classFilter) {
                filteredRecords = filteredRecords.filter(record => record.class === classFilter);
            }
            
            // Filter by date
            if (dateFilter) {
                const filterDate = new Date(dateFilter).toDateString();
                filteredRecords = filteredRecords.filter(record => record.date === filterDate);
            } else {
                // Default to today if no date filter
                const today = new Date().toDateString();
                filteredRecords = filteredRecords.filter(record => record.date === today);
            }
            
            // Filter by search term
            if (searchTerm) {
                filteredRecords = filteredRecords.filter(record => 
                    record.name.toLowerCase().includes(searchTerm) ||
                    record.nisn.includes(searchTerm)
                );
            }
            
            const attendanceList = document.getElementById('attendanceList');
            attendanceList.innerHTML = '';
            
            if (filteredRecords.length === 0) {
                attendanceList.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Tidak ada data absensi ditemukan</p>';
            } else {
                filteredRecords.forEach(record => {
                    const recordEl = document.createElement('div');
                    recordEl.className = 'bg-white rounded-lg p-3 border border-gray-200';
                    recordEl.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-medium text-gray-800">${record.name}</div>
                                <div class="text-sm text-gray-600">NISN: ${record.nisn} | Kelas: ${record.class}</div>
                                <div class="text-xs text-gray-500">Tanggal: ${record.date} | Waktu: ${record.time}</div>
                            </div>
                            <div class="text-xs text-gray-500">
                                üìç ${record.location.latitude.toFixed(4)}, ${record.location.longitude.toFixed(4)}
                            </div>
                        </div>
                    `;
                    attendanceList.appendChild(recordEl);
                });
            }
            
            const attendanceCount = document.getElementById('attendanceCount');
            if (attendanceCount) {
                attendanceCount.textContent = filteredRecords.length;
            }
        }

        // Modal close
        closeModal.addEventListener('click', () => {
            successModal.classList.add('hidden');
            requestLocation(); // Request location again for next attendance
        });

        // Make deleteStudent function global for onclick handlers
        window.deleteStudent = deleteStudent;

        // Initialize app
        init();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9853fcd6c19ece39',t:'MTc1ODkwMjU2Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
